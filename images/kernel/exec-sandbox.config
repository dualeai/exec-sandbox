# exec-sandbox kernel config fragment
# Merged with Alpine linux-virt config via scripts/kconfig/merge_config.sh
# Zero-maintenance: only intentional overrides listed here.
# When Alpine updates the kernel, merge_config.sh + make olddefconfig
# auto-inherits new defaults.
#
# Audit: Alpine linux-virt has 1582 =y and 889 =m options.
# This fragment disables ~360+ unused options for microVM boot speed.

# ============================================================
# FORCE BUILT-IN: boot-critical drivers (eliminate module loading)
# ============================================================
# CONFIG_MODULES is not set
CONFIG_VIRTIO=y
CONFIG_VIRTIO_BLK=y
CONFIG_VIRTIO_MMIO=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_VIRTIO_NET=y
CONFIG_NET_FAILOVER=y
CONFIG_FAILOVER=y
CONFIG_VIRTIO_BALLOON=y
CONFIG_EXT4_FS=y
CONFIG_JBD2=y
CONFIG_FS_MBCACHE=y
CONFIG_CRC16=y
CONFIG_CRYPTO_CRC32C=y
CONFIG_ZRAM=y
CONFIG_ZRAM_BACKEND_LZ4=y
# CONFIG_ZRAM_BACKEND_LZO is not set
# CONFIG_ZRAM_BACKEND_ZSTD is not set
# CONFIG_ZRAM_BACKEND_DEFLATE is not set
# CONFIG_ZRAM_BACKEND_842 is not set
CONFIG_ZRAM_DEF_COMP="lz4"
CONFIG_LZ4_COMPRESS=y
CONFIG_LZ4HC_COMPRESS=y

# ============================================================
# DISABLE: Hardware (no physical hardware in microVM)
# ============================================================
# CONFIG_USB_SUPPORT is not set
# CONFIG_SOUND is not set
# CONFIG_DRM is not set
# CONFIG_FB is not set
# CONFIG_BACKLIGHT_CLASS_DEVICE is not set
# CONFIG_THERMAL is not set
# CONFIG_WATCHDOG is not set
# CONFIG_HWMON is not set
# CONFIG_I2C is not set
# CONFIG_SPI is not set
# CONFIG_PINCTRL is not set
# Input/HID: headless VM, no keyboard/mouse/HID needed
# CONFIG_INPUT is not set
# CONFIG_HID is not set
# CONFIG_WIRELESS is not set
# CONFIG_WLAN is not set
# CONFIG_BT is not set
# CONFIG_NFC is not set
# CONFIG_LEDS_CLASS is not set
# CONFIG_PWM is not set
# CONFIG_MEDIA_SUPPORT is not set
# CONFIG_PPS is not set
# CONFIG_PTP_1588_CLOCK is not set
# CONFIG_CAN is not set
# CONFIG_SERIO is not set
# CONFIG_EDAC_SUPPORT is not set
# CONFIG_POWER_SUPPLY is not set
# CONFIG_IIO is not set
# CONFIG_INFINIBAND is not set
# GPIO: disable all consumers first, then GPIOLIB itself
# GPIO_PL061 in Alpine aarch64 base selects GPIOLIB_IRQCHIP → forces GPIOLIB=y
# CONFIG_GPIO_PL061 is not set
# CONFIG_GPIO_VIRTIO is not set
# CONFIG_GPIO_THUNDERX is not set
# CONFIG_GPIO_XGENE is not set
# CONFIG_GPIO_XGENE_SB is not set
# CONFIG_GPIO_SYSFS is not set
# CONFIG_GPIOLIB is not set
# DT overlays: QEMU virt passes static DTB, never applies runtime overlays
# (also cascades to disable OF_DYNAMIC and OF_RESOLVE)
# CONFIG_OF_OVERLAY is not set

# ============================================================
# DISABLE: VT/framebuffer/console display (serial-only)
# ============================================================
# CONFIG_VT is not set
# CONFIG_FRAMEBUFFER_CONSOLE is not set
# CONFIG_FONT_SUPPORT is not set

# ============================================================
# DISABLE: Storage (virtio-blk only)
# ============================================================
# CONFIG_SCSI is not set
# CONFIG_ATA is not set
# CONFIG_MD is not set
# CONFIG_BLK_DEV_DM is not set
# NVMe: NVME_CORE and NVME_FABRICS are hidden tristates, must disable all consumers
# CONFIG_BLK_DEV_NVME is not set
# CONFIG_NVME_RDMA is not set
# CONFIG_NVME_FC is not set
# CONFIG_NVME_TCP is not set
# CONFIG_NVME_APPLE is not set
# CONFIG_NVME_TARGET is not set
# Explicit NVME_TARGET sub-options (belt-and-suspenders for merge_config.sh ordering)
# CONFIG_NVME_TARGET_LOOP is not set
# CONFIG_NVME_TARGET_FC is not set
# CONFIG_NVME_TARGET_RDMA is not set
# CONFIG_NVME_TARGET_TCP is not set
# Hidden tristate disables (in case a consumer is missed)
# CONFIG_NVME_CORE is not set
# CONFIG_NVME_FABRICS is not set
# CONFIG_NVME_AUTH is not set
# CONFIG_BCACHE is not set
# CONFIG_BLK_DEV_BSG is not set
# CONFIG_BLK_DEV_INTEGRITY is not set
# CONFIG_BLK_DEV_PMEM is not set
# CONFIG_BLK_DEV_LOOP is not set
# CONFIG_BLK_DEV_RAM is not set
# CONFIG_BLK_DEV_NBD is not set
# CONFIG_BLK_DEV_DRBD is not set
# CONFIG_BLK_DEV_RBD is not set
# CONFIG_TARGET_CORE is not set
# CONFIG_MTD is not set

# Block I/O schedulers -- force "none" (host scheduler handles ordering)
# "none" eliminates ~40% IOPS overhead vs mq-deadline for single-queue virtio-blk
# Ref: https://atlarge-research.com/pdfs/2024-io-schedulers.pdf
# CONFIG_IOSCHED_BFQ is not set
# CONFIG_MQ_IOSCHED_KYBER is not set
# CONFIG_MQ_IOSCHED_DEADLINE is not set
# CONFIG_BLK_DEBUG_FS is not set
# CONFIG_BLK_DEV_THROTTLING is not set

# Partition tables -- whole-disk ext4, no partition scanning
# CONFIG_PARTITION_ADVANCED is not set

# NVDIMM / persistent memory -- not in microVM
# CONFIG_LIBNVDIMM is not set
# CONFIG_DAX is not set

# ============================================================
# DISABLE: RTC drivers (keep only PL031 for ARM64 QEMU virt)
# ============================================================
# CONFIG_RTC_DRV_DS1286 is not set
# CONFIG_RTC_DRV_DS1511 is not set
# CONFIG_RTC_DRV_DS1553 is not set
# CONFIG_RTC_DRV_DS1685_FAMILY is not set
# CONFIG_RTC_DRV_DS1742 is not set
# CONFIG_RTC_DRV_DS2404 is not set
# CONFIG_RTC_DRV_M48T35 is not set
# CONFIG_RTC_DRV_M48T59 is not set
# CONFIG_RTC_DRV_MSM6242 is not set
# CONFIG_RTC_DRV_RP5C01 is not set
# CONFIG_RTC_DRV_STK17TA8 is not set

# ============================================================
# DISABLE: Filesystems (erofs + ext4 + tmpfs + proc/sys + overlayfs only)
# ============================================================
# CONFIG_BTRFS_FS is not set
# CONFIG_XFS_FS is not set
# CONFIG_NFS_FS is not set
# CONFIG_NFSD is not set
# CONFIG_CIFS is not set
# CONFIG_FUSE_FS is not set
CONFIG_OVERLAY_FS=y
# CONFIG_ISO9660_FS is not set
# CONFIG_UDF_FS is not set
# CONFIG_SQUASHFS is not set
# CONFIG_VFAT_FS is not set
# CONFIG_FAT_FS is not set
# CONFIG_NTFS3_FS is not set
CONFIG_EROFS_FS=y
CONFIG_EROFS_FS_ZIP=y
CONFIG_EROFS_FS_ZIP_LZ4=y
CONFIG_EROFS_FS_ZIP_LZ4HC=y
# Per-CPU kthread decompression workers: parallelize EROFS decompression across
# cores during boot (avoids serializing on a single workqueue thread).
# HIPRI runs workers at SCHED_FIFO priority for minimal scheduling latency.
# Ref: https://docs.kernel.org/filesystems/erofs.html
#      https://lore.kernel.org/linux-erofs/20220206064903.25309-1-hsiangkao@linux.alibaba.com/
CONFIG_EROFS_FS_PCPU_KTHREAD=y
CONFIG_EROFS_FS_PCPU_KTHREAD_HIPRI=y
# CONFIG_F2FS_FS is not set
# CONFIG_GFS2_FS is not set
# CONFIG_OCFS2_FS is not set
# CONFIG_JFS_FS is not set
# CONFIG_9P_FS is not set
# CONFIG_CEPH_FS is not set
# CONFIG_NETWORK_FILESYSTEMS is not set
# CONFIG_FS_ENCRYPTION is not set
# CONFIG_FS_VERITY is not set
# CONFIG_FSCACHE is not set
# CONFIG_QUOTA is not set
# CONFIG_NLS is not set
# CONFIG_EXT4_FS_POSIX_ACL is not set
# CONFIG_FANOTIFY is not set
# CONFIG_AUTOFS_FS is not set
# CONFIG_AUTOFS4_FS is not set

# ============================================================
# DISABLE: Network protocols (TCP/UDP/Unix/IPv6 only)
# ============================================================
# CONFIG_SCTP is not set
# CONFIG_DCCP is not set
# CONFIG_RDS is not set
# CONFIG_TIPC is not set
# CONFIG_OPENVSWITCH is not set
# CONFIG_BRIDGE is not set
# CONFIG_IEEE802154 is not set
# CONFIG_CAIF is not set
# CONFIG_MPTCP is not set
# CONFIG_MPLS is not set

# IPsec/XFRM -- no VPN in sandbox
# CONFIG_XFRM is not set
# CONFIG_NET_KEY is not set

# Traffic control / QoS -- not needed
# CONFIG_NET_SCHED is not set

# IP advanced routing / multicast -- simple networking only
# CONFIG_IP_ADVANCED_ROUTER is not set
# CONFIG_IP_MULTICAST is not set
# CONFIG_IP_MROUTE is not set

# IPv6 advanced features
# CONFIG_IPV6_MROUTE is not set
# CONFIG_IPV6_OPTIMISTIC_DAD is not set
# CONFIG_IPV6_ROUTER_PREF is not set
# CONFIG_IPV6_ROUTE_INFO is not set
# CONFIG_IPV6_SIT_6RD is not set

# TCP options -- no BGP in sandbox
# CONFIG_TCP_MD5SIG is not set

# IPVS (load balancing) -- not a load balancer
# CONFIG_IP_VS is not set

# Legacy serial/dial-up protocols
# CONFIG_SLIP is not set
# CONFIG_PPP is not set

# Overlay / tunnel / bonding / teaming -- not needed in microVM
# CONFIG_VSOCKETS is not set
# CONFIG_BONDING is not set
# CONFIG_VXLAN is not set
# CONFIG_GENEVE is not set
# CONFIG_MACSEC is not set
# CONFIG_DUMMY is not set
# CONFIG_VLAN_8021Q is not set
# CONFIG_NET_IPGRE is not set
# CONFIG_NET_IPIP is not set
# CONFIG_IPV6_SIT is not set
# CONFIG_IPV6_TUNNEL is not set
# CONFIG_IPV6_GRE is not set
# CONFIG_L2TP is not set
# CONFIG_SMC is not set
# CONFIG_TLS is not set
# CONFIG_NET_TEAM is not set
# CONFIG_IPVLAN is not set
# CONFIG_MACVLAN is not set

# VPN drivers -- no VPN in sandbox
# CONFIG_WIREGUARD is not set
# CONFIG_OVPN is not set

# Misc networking
# CONFIG_NETCONSOLE is not set
# CONFIG_XDP_SOCKETS is not set
# CONFIG_BAREUDP is not set
# CONFIG_NLMON is not set
# CONFIG_VETH is not set
# BPF stream parser: sockmap/BPF-based stream parsing, not used
# CONFIG_BPF_STREAM_PARSER is not set
# CONFIG_NETWORK_PHY_TIMESTAMPING is not set
# CONFIG_NET_DEVMEM is not set
# CONFIG_NET_HANDSHAKE is not set

# Netfilter -- disable advanced features, keep basic
# CONFIG_NETFILTER_ADVANCED is not set
# CONFIG_NF_CONNTRACK_OVS is not set
# CONFIG_NF_TABLES_ARP is not set
# CONFIG_NF_TABLES_NETDEV is not set

# Ethernet PHY layer -- virtio-net uses virtqueue, not MDIO/PHY
# CONFIG_PHYLIB is not set
# CONFIG_PHYLINK is not set
# CONFIG_MDIO_DEVICE is not set
# CONFIG_FIXED_PHY is not set

# Physical NIC drivers -- only virtio-net needed
# CONFIG_NET_VENDOR_AMAZON is not set
# CONFIG_NET_VENDOR_GOOGLE is not set
# CONFIG_NET_VENDOR_INTEL is not set
# CONFIG_NET_VENDOR_MELLANOX is not set
# CONFIG_VMXNET3 is not set

# ============================================================
# DISABLE: Firmware/boot (direct -kernel boot)
# ============================================================
# CONFIG_EFI is not set
# CONFIG_DMI is not set

# ============================================================
# DISABLE: Virtualization host (guest-only, not a hypervisor)
# ============================================================
# CONFIG_VIRTUALIZATION is not set
# CONFIG_KVM is not set
# CONFIG_VHOST_MENU is not set
# CONFIG_IOMMUFD is not set

# IOMMU/SMMU -- no device passthrough
# CONFIG_IOMMU_SUPPORT is not set

# Legacy virtio PCI (QEMU uses modern 1.0+)
# CONFIG_VIRTIO_PCI_LEGACY is not set

# Hyper-V guest -- not on Hyper-V
# CONFIG_HYPERV is not set

# ============================================================
# DISABLE: Security LSMs (security enforced at VM boundary)
# Keep YAMA for ptrace_scope sysctl used by guest-agent
# ============================================================
# CONFIG_SECURITY_APPARMOR is not set
# CONFIG_SECURITY_LANDLOCK is not set
# CONFIG_SECURITY_LOCKDOWN_LSM is not set
# CONFIG_AUDIT is not set
# CONFIG_INTEGRITY is not set
CONFIG_SECURITY_YAMA=y
CONFIG_SECURITY_DMESG_RESTRICT=y

# ============================================================
# DISABLE: Debug/trace/profiling (production microVM)
# DEBUG_KERNEL enabled as menu gate for security debug options
# ============================================================
# CONFIG_DEBUG_INFO is not set
# CONFIG_DEBUG_INFO_BTF is not set
# CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT is not set
# CONFIG_FTRACE is not set
# CONFIG_KPROBES is not set
# CONFIG_UPROBES is not set
# CONFIG_PROFILING is not set
# CONFIG_PERF_EVENTS is not set
CONFIG_DEBUG_KERNEL=y
# Security-critical debug checks (minimal overhead, require DEBUG_KERNEL)
CONFIG_DEBUG_WX=y
CONFIG_DEBUG_CREDENTIALS=y
CONFIG_DEBUG_NOTIFIERS=y
CONFIG_DEBUG_LIST=y
CONFIG_DEBUG_SG=y
CONFIG_DEBUG_VIRTUAL=y
# CONFIG_DEBUG_FS is not set
# CONFIG_DYNAMIC_DEBUG is not set
# CONFIG_MAGIC_SYSRQ is not set
# CONFIG_SCHEDSTATS is not set
# CONFIG_SOFTLOCKUP_DETECTOR is not set
# CONFIG_DETECT_HUNG_TASK is not set
# CONFIG_KALLSYMS is not set
# CONFIG_DEBUG_BUGVERBOSE is not set
# CONFIG_SYMBOLIC_ERRNAME is not set
# CONFIG_PROC_KCORE is not set

# ============================================================
# DISABLE: Memory/CPU features not needed in microVM
# ============================================================
# CONFIG_NUMA is not set
# CONFIG_MEMORY_HOTPLUG is not set
# CONFIG_HOTPLUG_CPU is not set
# CONFIG_KSM is not set
# CONFIG_ZSWAP is not set
# CONFIG_CHECKPOINT_RESTORE is not set
# CONFIG_HUGETLBFS is not set
# CONFIG_KFENCE is not set
# Compaction: required for THP infrastructure (large folio splitting).
# With transparent_hugepage=never boot param, compaction sees minimal
# activity — only triggered by explicit madvise or EROFS folio reclaim.
CONFIG_COMPACTION=y
# CMA: for GPU/DMA hardware buffers, irrelevant in microVM
# CONFIG_CMA is not set

# ============================================================
# DISABLE: Scheduler autogroup (disposable single-task VM)
# ============================================================
# CONFIG_SCHED_AUTOGROUP is not set

# ============================================================
# DISABLE: CPU frequency scaling (virtual CPU, MSR writes are no-ops)
# ============================================================
# KVM silently drops MSR_IA32_PERF_CTL writes (dummy handler in
# kvm_set_msr_common). HWP MSRs (PM_ENABLE, HWP_REQUEST) are not
# emulated at all. intel_pstate loads but accomplishes nothing —
# sysfs values are fabricated. An Amazon patch (KVM_CAP_CPU_FREQ_SCALING,
# 2022) to make guest P-state control real was rejected upstream.
# Real P-state control exists only on bare-metal instances (e.g. AWS .metal).
# Firecracker enables CPU_FREQ for general-purpose compatibility, not function.
# CONFIG_CPU_FREQ is not set

# ============================================================
# DISABLE: Power management (disposable microVM)
# ============================================================
# CONFIG_SUSPEND is not set
# CONFIG_HIBERNATION is not set

# ============================================================
# DISABLE: Crash/kexec (disposable microVM, no recovery)
# ============================================================
# CONFIG_KEXEC is not set
# CONFIG_CRASH_DUMP is not set
# CONFIG_PSTORE is not set
# CONFIG_PVPANIC is not set

# ============================================================
# DISABLE: Cgroup v1 legacy controllers (cgroup v2 unified hierarchy only)
# ============================================================
# These are cgroup v1 controllers superseded by cgroup v2 built-in controllers.
# In v2, cpu/freezer/device controllers are automatic — no separate CONFIG needed.
# CONFIG_CGROUP_CPUACCT is not set
# CONFIG_CGROUP_DEVICE is not set
# CONFIG_CGROUP_FREEZER is not set
# Hugetlb cgroup: HUGETLBFS disabled → dead code
# CONFIG_CGROUP_HUGETLB is not set
# Perf cgroup: PERF_EVENTS disabled → dead code
# CONFIG_CGROUP_PERF is not set
# BPF cgroup attachment: not used (seccomp uses cBPF, not cgroup-attached eBPF)
# CONFIG_CGROUP_BPF is not set
# Network traffic classid/priority: no tc/QoS in sandbox
# CONFIG_CGROUP_NET_CLASSID is not set
# CONFIG_CGROUP_NET_PRIO is not set
# DMEM cgroup: device memory accounting, no GPU/DMA hardware
# CONFIG_CGROUP_DMEM is not set
# RDMA cgroup: no InfiniBand/RDMA hardware
# CONFIG_CGROUP_RDMA is not set
# Misc cgroup: platform-specific resource tracking
# CONFIG_CGROUP_MISC is not set

# ============================================================
# DISABLE: Process accounting (not monitored)
# ============================================================
# CONFIG_BSD_PROCESS_ACCT is not set
# TASKSTATS: unused — no monitoring daemon in disposable microVM.
# Saves ~15KB kernel binary + minor boot time from netlink setup.
# CONFIG_TASKSTATS is not set

# ============================================================
# DISABLE: Memory error handling (virtual guest, hypervisor handles HW errors)
# ============================================================
# Hardware memory failure (ECC errors): hypervisor handles physical MCE events
# CONFIG_MEMORY_FAILURE is not set
# HWPoison inject: testing-only injector for simulating memory errors
# CONFIG_HWPOISON_INJECT is not set
# Software page poisoning: superseded by INIT_ON_FREE_DEFAULT_ON=y (KSPP)
# CONFIG_PAGE_POISONING is not set

# ============================================================
# DISABLE: Coredump (sandbox, no debugging)
# ============================================================
# CONFIG_COREDUMP is not set
# CONFIG_ELF_CORE is not set

# ============================================================
# DISABLE: Crypto self-tests (5-15ms boot savings)
# ============================================================
CONFIG_CRYPTO_MANAGER_DISABLE_TESTS=y

# ============================================================
# DISABLE: Unused crypto (keep only CRC32C/SHA256/HMAC/AES)
# ============================================================
# CONFIG_CRYPTO_CBC is not set
# CONFIG_CRYPTO_CTS is not set
# CONFIG_CRYPTO_ECB is not set
# CONFIG_CRYPTO_AEGIS128_SIMD is not set
# CONFIG_CRYPTO_MD5 is not set
# CONFIG_CRYPTO_SHA3 is not set
# CONFIG_CRYPTO_DH is not set
# CONFIG_CRYPTO_KPP is not set
# CONFIG_CRYPTO_DEV_CCP is not set
# CONFIG_CRYPTO_HW is not set
# User-space crypto API: no user-space crypto consumers in sandbox
# (=m in Alpine, dead with MODULES=n, but explicit for documentation)
# CONFIG_CRYPTO_USER_API_HASH is not set
# CONFIG_CRYPTO_USER_API_SKCIPHER is not set
# CONFIG_CRYPTO_USER_API_RNG is not set
# CONFIG_CRYPTO_USER_API_AEAD is not set
# CCM mode: used by WPA2/Bluetooth, neither present in microVM
# CONFIG_CRYPTO_CCM is not set
# CONFIG_CRYPTO_LIB_CURVE25519_GENERIC is not set
# CONFIG_CRYPTO_LIB_POLY1305_ARCH is not set

# ============================================================
# DISABLE: Kernel keyring (no dm-crypt, no IMA)
# ============================================================
# CONFIG_KEYS is not set

# ============================================================
# DISABLE: DMA engine / mailbox / platform drivers / misc
# ============================================================
# CONFIG_DMADEVICES is not set
# CONFIG_MAILBOX is not set
# CONFIG_RESET_CONTROLLER is not set
# HW_RANDOM: virtio-rng entropy source for post-snapshot CRNG reseed
CONFIG_HW_RANDOM=y
CONFIG_HW_RANDOM_VIRTIO=y
# CONFIG_RELAY is not set
# CONFIG_CONNECTOR is not set
# CONFIG_DLM is not set
# CONFIG_TUN is not set
# CONFIG_TAP is not set
# CONFIG_VDPA is not set
# CONFIG_RPMSG_VIRTIO is not set
# CONFIG_EEPROM_93CX6 is not set
# CONFIG_FW_CFG_SYSFS is not set
# VM Generation ID: kernel auto-reseeds CRNG on snapshot restore via ACPI notification.
# Disabled because x86 microvm uses acpi=off. L1 restore CRNG reseed is handled by
# guest-agent RNDRESEEDCRNG ioctl instead (see guest-agent/src/main.rs reseed_crng).
# CONFIG_VMGENID is not set
# NVMEM: no EEPROM/eFuse hardware in QEMU virt
# CONFIG_NVMEM is not set
# DMA_SHARED_BUFFER: invisible bool, prevent selectors
# (DRM=n already; also disable remaining selectors)
# CONFIG_SYNC_FILE is not set
# CONFIG_DMABUF_HEAPS is not set

# ============================================================
# DISABLE: Firmware loading (no HW needing firmware)
# ============================================================
# CONFIG_FW_LOADER_USER_HELPER is not set
# CONFIG_FW_CACHE is not set

# ============================================================
# DISABLE: Unused initramfs decompressors (keep zstd only)
# ============================================================
# CONFIG_RD_BZIP2 is not set
# CONFIG_RD_LZMA is not set
# CONFIG_RD_LZO is not set
# CONFIG_RD_XZ is not set
# CONFIG_RD_LZ4 is not set
CONFIG_RD_ZSTD=y

# ============================================================
# DISABLE: Platform-specific (HiSilicon/Qualcomm/Cavium/etc.)
# ============================================================
# ARM64 SoC platforms: disable unused ones to break GPIOLIB/PINCTRL select chains.
# ARCH_QCOM selects GPIOLIB + PINCTRL; ARCH_HISI selects PINCTRL;
# ARCH_THUNDER2 and ARCH_VEXPRESS select GPIOLIB. None needed for QEMU virt.
# CONFIG_ARCH_QCOM is not set
# CONFIG_ARCH_HISI is not set
# CONFIG_ARCH_THUNDER2 is not set
# CONFIG_ARCH_VEXPRESS is not set
# CONFIG_ARCH_ALPINE is not set
# CONFIG_ARCH_XGENE is not set
# CONFIG_QCOM_EBI2 is not set
# CONFIG_COMMON_CLK_HI3670 is not set
# CONFIG_PCI_HISI is not set
# CONFIG_PCI_HOST_THUNDER_ECAM is not set
# CONFIG_PCI_HOST_THUNDER_PEM is not set
# CONFIG_PCI_XGENE is not set
# CONFIG_VEXPRESS_CONFIG is not set
# CONFIG_ARM_TIMER_SP804 is not set

# ============================================================
# DISABLE: ACPI subsystems not needed in microVM
# ============================================================
# CONFIG_ACPI_AC is not set
# CONFIG_ACPI_BATTERY is not set
# CONFIG_ACPI_CONTAINER is not set
# CONFIG_ACPI_APEI is not set
# CONFIG_ACPI_DEBUG is not set
# CONFIG_ACPI_HOTPLUG_CPU is not set
# CONFIG_ACPI_HOTPLUG_MEMORY is not set
# CONFIG_ACPI_NUMA is not set
# CONFIG_ACPI_PCI_SLOT is not set
# CONFIG_ACPI_TABLE_UPGRADE is not set
# ACPI button: power/lid events irrelevant (VM killed via monitor, not ACPI)
# CONFIG_ACPI_BUTTON is not set
# CONFIG_ACPI_TINY_POWER_BUTTON is not set
# ACPI thermal/fan: no thermal management in virtual guest
# CONFIG_ACPI_THERMAL is not set
# CONFIG_ACPI_FAN is not set
# ACPI processor: P-states are no-ops in KVM (see CPU_FREQ comment above).
# C-states via MWAIT are converted to HLT VM-exits by KVM unless
# KVM_CAP_X86_DISABLE_EXITS + cstate_in_guest is set (not our case).
# Haltpoll handles the only idle decision that matters (poll vs HLT).
# CONFIG_ACPI_PROCESSOR is not set
# ACPI dock: no docking station in VM
# CONFIG_ACPI_DOCK is not set

# ============================================================
# DISABLE: 8250 UART exotic variants (keep core 8250 for x86 ttyS0 fallback)
# ============================================================
# CONFIG_SERIAL_8250_PCI is not set
# CONFIG_SERIAL_8250_EXAR is not set
# CONFIG_SERIAL_8250_PERICOM is not set
# CONFIG_SERIAL_8250_RSA is not set
# CONFIG_SERIAL_8250_FSL is not set

# ============================================================
# DISABLE: PCI host controllers + features (keep base PCI)
# ============================================================
# CONFIG_HOTPLUG_PCI is not set
# CONFIG_PCI_IOV is not set
# CONFIG_PCI_ATS is not set
# CONFIG_PCIEASPM is not set
# PCIe port driver: virtio-pci uses plain PCI, not PCIe port services (AER/PME/hotplug)
# Eliminates portdrv.o, rcec.o, bwctrl.o, pme.o (aspm.o is obj-y, stays)
# CONFIG_PCIEPORTBUS is not set

# ============================================================
# DISABLE: ARM64-specific features not needed in QEMU virt
# ============================================================
# CONFIG_ARM64_SVE is not set
# CONFIG_ARM64_SME is not set
# CONFIG_ARM64_MTE is not set
# ARM SDEI: RAS NMI-like firmware callbacks, not implemented in QEMU virt
# CONFIG_ARM_SDE_INTERFACE is not set
# SMCCC SoC ID: sysfs SoC identification, not needed in microVM
# CONFIG_ARM_SMCCC_SOC_ID is not set

# ============================================================
# SECURITY: ARM64 hardware CFI (ARMv8.3+/8.5+)
# ============================================================
# Shadow Call Stack: hardware return address protection (prevents ROP)
CONFIG_SHADOW_CALL_STACK=y
# Pointer Authentication: hardware return address signing (ARMv8.3+)
CONFIG_ARM64_PTR_AUTH=y
CONFIG_ARM64_PTR_AUTH_KERNEL=y
# Branch Target Identification: forward-edge CFI (ARMv8.5+)
CONFIG_ARM64_BTI=y
CONFIG_ARM64_BTI_KERNEL=y

# ============================================================
# DISABLE: x86-specific features not needed in virtual guest
# ============================================================
# CONFIG_X86_SGX is not set
# CONFIG_MICROCODE is not set
# CONFIG_AMD_MEM_ENCRYPT is not set
# x86 attack surface reduction (KSPP/kernel-hardening-checker)
# CONFIG_X86_CPUID is not set
# CONFIG_X86_IOPL_IOPERM is not set
# CONFIG_X86_MSR is not set
# CONFIG_DEVPORT is not set
# CONFIG_X86_VSYSCALL_EMULATION is not set
# EDD: BIOS Enhanced Disk Drive probing (irrelevant with direct -kernel boot)
# CONFIG_EDD is not set
# I/O port delay: none (no real hardware in VM, eliminates outb 0x80 overhead)
CONFIG_IO_DELAY_NONE=y

# ============================================================
# PARAVIRTUALIZATION: KVM/HVF guest optimizations (x86_64)
# ============================================================
# Enable hypervisor detection + paravirt ops framework
CONFIG_HYPERVISOR_GUEST=y
CONFIG_PARAVIRT=y
# KVM guest: kvmclock, PV EOI, PV TLB flush, PV sched yield (10-30ms boot)
CONFIG_KVM_GUEST=y
# kvmclock as clocksource (avoids TSC calibration, 5-15ms boot savings)
CONFIG_PARAVIRT_CLOCK=y
# PVH direct 64-bit boot entry (skips real-mode transition, 30-50ms faster)
CONFIG_PVH=y
# Do NOT enable PV spinlocks — single vCPU has zero contention
# CONFIG_PARAVIRT_SPINLOCKS is not set

# ============================================================
# TIMER: Reduce VM exits from timer interrupts
# ============================================================
# 100 Hz = fewer timer ticks = fewer VM exits (vs 250 Hz default)
# 10ms scheduling resolution is fine for script execution workloads
CONFIG_HZ_100=y
CONFIG_HZ=100
# CONFIG_HZ_250 is not set
# CONFIG_HZ_300 is not set
# CONFIG_HZ_1000 is not set
# Suppress tick when idle (standard for VMs)
CONFIG_NO_HZ_IDLE=y

# ============================================================
# HALTPOLL: Avoid VM-exit on short idle (KVM only at runtime)
# ============================================================
# Polls in-guest before issuing HLT, avoiding VM-exit cost on short idle
# windows.  Measured: 20% latency reduction (sockperf), 4-71% FPS gain.
# Adaptive polling window (default 200µs) grows on bursty wakeups, shrinks
# when idle.  Guest haltpoll disables redundant host-side KVM halt polling
# via MSR_KVM_POLL_CONTROL and sets POLL flag to avoid IPI on remote wakeup.
# Firecracker, Cloud Hypervisor, and QEMU/KVM all converge on this approach.
#
# Kernel 6.x change: the governor's init_haltpoll() no longer gates on
# kvm_para_available() (LKML 2023-11 "Drop kvm_para_available() check"),
# so it registers on ANY hypervisor.  The cpuidle-haltpoll DRIVER still
# requires KVM paravirt, but the governor itself activates unconditionally.
# On HVF the 200µs busy-loop (cpu_relax → ARM64 yield at full speed) causes
# ~65% idle CPU per vCPU because background wakeups (RCU, virtio) trigger
# ~3k poll cycles/sec with no KVM MSR coordination to amortise the cost.
#
# Runtime strategy (see qemu_cmd.py):
#   KVM:      cpuidle.governor=haltpoll  — in-guest poll avoids HLT VM-exits
#   HVF/TCG:  cpuidle.off=1             — disable cpuidle entirely
#
# Why cpuidle.off=1 on HVF/TCG:  QEMU's virt machine generates no
# idle-states DT nodes, so the guest has only poll (busy-loop) and WFI.
# Any governor (menu, TEO) would always select WFI — the prediction
# algorithm is wasted overhead.  cpuidle.off=1 bypasses the framework
# and calls cpu_do_idle() (WFI) directly, the shortest idle path.
CONFIG_CPU_IDLE=y
CONFIG_CPU_IDLE_GOV_HALTPOLL=y
CONFIG_HALTPOLL_CPUIDLE=y
# Ladder: irrelevant with NO_HZ_IDLE=y (needs periodic tick for promotion).
# Menu: force-selected by Kconfig (CPU_IDLE + NO_HZ_IDLE), cannot be removed.
# Unused at runtime — KVM uses haltpoll, HVF/TCG disables cpuidle entirely.
# TEO: alternative to menu (since 5.1), not needed when haltpoll is forced.
# CONFIG_CPU_IDLE_GOV_LADDER is not set

# ============================================================
# Transparent Hugepages: madvise mode for EROFS large folios
# ============================================================
# THP in madvise mode + transparent_hugepage=never boot param disables
# anonymous 2MB hugepages (khugepaged stays idle, no compaction stalls)
# while enabling file-backed large folios for EROFS compressed reads.
# Since kernel 6.11, EROFS calls mapping_set_large_folios() on all
# inodes, but this requires CONFIG_TRANSPARENT_HUGEPAGE=y — without it,
# mapping_max_folio_order() unconditionally returns 0 (4KB pages only).
# With large folios, EROFS reads 16-64KB per page fault instead of 4KB,
# reducing fault count ~16x. On HVF (macOS) where each fault triggers a
# ~360µs VM exit, this cuts cold-start time dramatically.
CONFIG_TRANSPARENT_HUGEPAGE=y
CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y

# ============================================================
# PERFORMANCE: Kernel compression + compiler optimizations
# ============================================================
# LZ4: ~3x faster decompression than gzip, reduces kernel boot time
CONFIG_KERNEL_LZ4=y
# Optimize for performance: -O2 enables loop unrolling and aggressive inlining
# critical for LZ4 decompression in EROFS. -Os was 2-5x slower for data-intensive
# paths (LZ4 memcpy loops, page fault handlers). Kernel binary grows ~10% but
# instruction cache pressure is negligible on 1-vCPU microVMs running a single workload.
# Ref: kernel commit b1a3e75e466d "lz4: fix kernel decompression speed" (10x regression
# when memcpy not inlined — same class of issue with -Os).
CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
# Slab allocator hardening (SLUB_TINY removed: blocks freelist hardening)
# XOR-obfuscated freelist pointers (blocks heap corruption exploits)
CONFIG_SLAB_FREELIST_HARDENED=y
# Randomize freelist order (frustrates heap spray attacks)
CONFIG_SLAB_FREELIST_RANDOM=y
# Multiple kmalloc cache copies (isolates cross-slab attacks)
CONFIG_RANDOM_KMALLOC_CACHES=y
# Server workload: lowest scheduling overhead (no preemption points)
CONFIG_PREEMPT_NONE=y
# Expedited RCU grace periods during boot (5-15ms savings)
CONFIG_RCU_EXPEDITE_BOOT=y
# Favor dynamic cgroup modifications — reduces KVM_CREATE_VM latency jitter (0-40ms → stable)
# Ref: https://blog.davidv.dev/posts/minimizing-linux-boot-times/
CONFIG_CGROUP_FAVOR_DYNMODS=y
# Trust CPU hardware RNG (RDRAND) for CRNG seeding at boot (defense-in-depth)
# Matches boot param random.trust_cpu=on. Prevents entropy starvation in VMs.
CONFIG_RANDOM_TRUST_CPU=y

# ============================================================
# SECURITY HARDENING: KSPP + sandbox-specific
# ============================================================
# Crash on oops instead of continuing in undefined state (disposable VM)
CONFIG_PANIC_ON_OOPS=y
CONFIG_PANIC_TIMEOUT=-1
# Zero all stack variables (prevents info leaks + uninitialized var exploits)
CONFIG_INIT_STACK_ALL_ZERO=y
# Randomize kernel stack offset per syscall
CONFIG_RANDOMIZE_KSTACK_OFFSET_DEFAULT=y
# Crash on data structure corruption detection
CONFIG_BUG_ON_DATA_CORRUPTION=y
# Harden linked list operations
CONFIG_LIST_HARDENED=y
# Disable legacy interfaces that are security risks
# CONFIG_BINFMT_MISC is not set
# CONFIG_LEGACY_PTYS is not set
# CONFIG_LEGACY_TIOCSTI is not set
# CONFIG_COMPAT_BRK is not set
# CONFIG_USERFAULTFD is not set
# CONFIG_LDISC_AUTOLOAD is not set
# eBPF syscall: #1 kernel privesc vector since 2020 (CVE-2020-8835, CVE-2021-3490,
# CVE-2023-2163). Seccomp uses cBPF (classic BPF) which does NOT depend on BPF_SYSCALL.
# BPF_JIT=y still JIT-compiles cBPF seccomp filters via CONFIG_BPF (auto-enabled).
# CONFIG_BPF_SYSCALL is not set
# io_uring: 60% of Google kernel bug bounty; Python/Node use epoll, not io_uring
# CONFIG_IO_URING is not set
# Fully disable /dev/mem (KSPP: no hardware debug needed in sandbox)
# CONFIG_DEVMEM is not set
# Static usermode helper (empty path = disable all, no modprobe needed)
CONFIG_STATIC_USERMODEHELPER=y
CONFIG_STATIC_USERMODEHELPER_PATH=""
# Usercopy bounds checking (validates copy_to/from_user within slab bounds)
CONFIG_HARDENED_USERCOPY=y
# Page table validation (detects double-mapping exploitation primitive)
CONFIG_PAGE_TABLE_CHECK=y
CONFIG_PAGE_TABLE_CHECK_ENFORCED=y
# Compile-time + runtime buffer overflow detection (KSPP, zero overhead)
CONFIG_FORTIFY_SOURCE=y
# Zero caller-used registers on function return (blocks ROP gadgets, ~1%)
CONFIG_ZERO_CALL_USED_REGS=y
# Heap zeroing on alloc (belt+suspenders with boot param init_on_alloc=1)
CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y
# Prevent slab cache merging (heap overflow isolation, boot param: slab_nomerge)
# CONFIG_SLAB_MERGE_DEFAULT is not set
# ASLR info leak: disable /proc/*/smaps, /proc/*/pagemap
# CONFIG_PROC_PAGE_MONITOR is not set
# Socket diagnostic interface (used in heap spray attacks)
# CONFIG_INET_DIAG is not set
# Legacy syscalls (known exploit vectors)
# CONFIG_SYSFS_SYSCALL is not set
# CONFIG_USELIB is not set
# Legacy async I/O (Python/Node use epoll, not aio)
# CONFIG_AIO is not set
# Prevent force access to /proc/pid/mem (kernel 6.12+)
CONFIG_PROC_MEM_NO_FORCE=y
# Page allocator randomization (frustrates heap layout prediction)
CONFIG_SHUFFLE_PAGE_ALLOCATOR=y
# init_on_free: 3-5% runtime overhead from cache pollution (zeroing cold pages).
# init_on_alloc alone blocks info leaks from new allocations; init_on_free's
# marginal benefit (reducing UAF window) is not worth the cost in sandbox context.
# CONFIG_INIT_ON_FREE_DEFAULT_ON is not set
# Stack overflow detection (near-zero cost)
CONFIG_SCHED_STACK_END_CHECK=y
# Erase kernel stack between syscalls (replaces GCC_PLUGIN_STACKLEAK)
CONFIG_KSTACK_ERASE=y
# UBSAN array bounds checking (catches OOB at runtime)
CONFIG_UBSAN=y
CONFIG_UBSAN_BOUNDS=y
CONFIG_UBSAN_TRAP=y
# CONFIG_UBSAN_SHIFT is not set
# CONFIG_UBSAN_DIV_ZERO is not set
# CONFIG_UBSAN_UNREACHABLE is not set
# CONFIG_UBSAN_INTEGER_WRAP is not set
# CONFIG_UBSAN_BOOL is not set
# CONFIG_UBSAN_ENUM is not set
# CONFIG_UBSAN_ALIGNMENT is not set
# Remove unused exported symbols (pairs with MODULES=n)
CONFIG_TRIM_UNUSED_KSYMS=y

# ============================================================
# SECURITY: x86_64-specific hardening
# ============================================================
# Remove fixed-address ROP targets (musl doesn't use vsyscall)
CONFIG_LEGACY_VSYSCALL_NONE=y
# No 32-bit binaries in sandbox (Alpine is pure 64-bit)
# CONFIG_IA32_EMULATION is not set
# CONFIG_X86_X32_ABI is not set
# Block LDT manipulation exploits
# CONFIG_MODIFY_LDT_SYSCALL is not set
# Hardware CFI: Indirect Branch Tracking (Intel 12th gen+, AMD Zen 4+)
CONFIG_X86_KERNEL_IBT=y
# Straight-Line Speculation mitigation
CONFIG_MITIGATION_SLS=y

# ============================================================
# KEEP (rationale):
# ============================================================
# CONFIG_PCI=y          -- x86_64 TCG fallback uses virtio-pci
# CONFIG_ACPI=y         -- x86_64 pc machine type needs it
# CONFIG_BPF_JIT=y      -- JIT-compiles cBPF seccomp filters (depends on CONFIG_BPF, not BPF_SYSCALL)
# CONFIG_CGROUPS=y      -- kernel-internal scheduler (v1 controllers disabled above)
# CONFIG_CGROUP_PIDS=y  -- PID limiting (cgroup v2 core)
# CONFIG_NAMESPACES=y   -- restricted by max_user_namespaces=0
# CONFIG_SECCOMP=y      -- guest-agent security
# CONFIG_IPV6=y         -- user code may need it
# CONFIG_NETFILTER=y    -- basic packet filtering (not advanced)
# CONFIG_SWAP=y         -- zram swap is used
# CONFIG_SYSVIPC=y      -- Python multiprocessing may need it
# CONFIG_OF=y           -- ARM64 device tree (QEMU virt)
# CONFIG_ARM_AMBA=y     -- PL011 UART, PL031 RTC on ARM64
# CONFIG_RTC_DRV_PL031=y -- QEMU virt RTC (ARM64)
# CONFIG_MEMORY_BALLOON=y -- virtio-balloon uses this
# CONFIG_BALLOON_COMPACTION=y -- balloon page compaction
# CONFIG_SMP=y          -- keep even for 1 vCPU (future-proofing, minimal overhead)
